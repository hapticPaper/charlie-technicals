# Daily market report (acquire → analyze → aggregate → report → summarize → commit)

## Overview
Generate a daily MDX report (plus supporting JSON artifacts) for the configured universe and time windows.

The rendered report is split into:

- Market commentary (1–3 sentences; what matters over the next few sessions)
- Most-active names (dollar volume, within the configured universe)
- Technical trades (signal-based picks that pass the current filters)
- Watchlist commentary + stance (always present, even when there are zero technical trades)
- Technical analysis + visuals (charts) for both technical trades and watchlist names

### Selection rules (current)

- *Technical trades* (`report.picks`): momentum/breakout/levels setups, scored using multi-timeframe momentum (15m/1h/1d), daily breakouts (close above/below prior 20d/55d/252d highs/lows), pivot support/resistance proximity, and a simple supply/demand proxy (range expansion + volume confirmation). If ATR14 is available, names with a sub-1-ATR daily move are filtered out unless they are in a 20d/55d/252d breakout/breakdown.
- *Watchlist* (`report.watchlist`): prioritize liquid (high dollar-volume) names with clear momentum/trend bias and/or an explicit setup that is still sub-ATR on the day. Avoid "random" low-liquidity names unless they're showing a strong trade-quality setup.

### Narrative guidelines (required)

- Always include both:
  - *Market commentary* (what matters over the next few sessions; focus on breadth/volatility/concentration in plain English).
  - *Watchlist commentary* (our stance/bias on the watchlist names; what to watch for next).
- Keep it clean and concise (human-readable).
- Do not dump per-symbol indicator hits (e.g., "AIG: RSI overbought | …") into the narrative; keep that detail on the technical analysis charts/sections.

### Summarize step (required)

The **summarize** step is where we convert the computed `MarketReport` into a small, UI-ready payload that can be embedded into the MDX.

Key intent:

- The MDX should remain **declarative**: it includes *what to render* plus *the data to render it*.
- The MDX should not embed any UI output. It only includes component invocations (e.g. `<ReportSummary ... />`) and props.
- The report page should not need to “re-aggregate” or parse narrative text just to render summary widgets.

#### Summarize step contract

The summarize step MUST take a `MarketReport` and produce a `MarketReportSummaryWidgets` object.

The canonical schema lives in `src/market/types.ts`. This playbook documents intent + invariants; if it diverges from the TypeScript types, the code is authoritative and this doc should be updated.

Ownership:

- The `summary` payload is always generated by the report generator (see `src/market/summaryWidgets.ts`).
- MDX authors must not hand-edit or hand-construct this payload; it should be treated as an opaque, precomputed value.

References:

- Schema types: `src/market/types.ts` (`MarketReportSummaryWidgets` and related types)
- Builder (single source of truth for generation): `src/market/summaryWidgets.ts` (`buildReportSummaryWidgets(report)`)

Invariants:

- `narrative.mainIdea` and `narrative.veryShort` come directly from `report.summaries`.
- `sentiment.lines` must be normalized by the generator: trim whitespace, drop empty lines, and truncate to the first 1–3 valid lines. If no valid lines remain, `sentiment` must be `null`.
- `technicalTrades.total` is `report.picks.length`, and `technicalTrades.preview` is the first `REPORT_MAX_PICKS` entries (no extra UI-side sorting/parsing).
- `watchlist.total` is `report.watchlist.length`, and `watchlist.preview` is the first `REPORT_MAX_WATCHLIST` entries (no extra UI-side sorting/parsing).
- `mostActive` is derived from `report.mostActive.byDollarVolume1d` + `report.mostActive.byDollarVolume5d`.
  - `day.top` + `day.overflow` must preserve rank order and form a single ranked list (overflow is a continuation).
  - `week.top` must preserve rank order.
- `fullContext` comes directly from `report.summaries.summary`.
- Every list item must include a stable `key` field, precomputed by the generator (e.g. rank + symbol), so the UI is a pure renderer.

Failure behavior:

- Prefer safe defaults/coercions (e.g., truncation, nulling optional sections) over throwing during summarization so report generation stays robust.

Edge cases:

- If there are no picks/watchlist names, the corresponding `preview` must be `[]` and `hasMore` must be `false`.
- If `mostActive` data is missing/empty, `mostActive` must be `null`.
- If the summary payload needs to change for a rerun, do not edit MDX directly. Re-run `bun run market:run --date=<DATE>` to regenerate.

#### `ReportSummary` embedded payload (`MarketReportSummaryWidgets`)

The report generator embeds a precomputed `summary` prop into the MDX:

```mdx
<ReportSummary summary={...} />
```

This `summary` object is a persisted, versioned schema (historical MDX keeps whatever was embedded at generation time).

Consumers should treat the payload as data-only input (not something to be parsed/derived from narrative text at render-time). The current schema is:

- `version`: must be `"v1-summary-widgets"`.
- `narrative`:
  - `mainIdea`: the top narrative headline.
  - `veryShort`: ultra-compact summary (<= `REPORT_VERY_SHORT_MAX_WORDS`).
- `sentiment`: `null` or `{ tone, lines }`.
  - `tone`: one of `"risk-on" | "risk-off" | "mixed"`.
  - `lines`: 1–3 bullets, already trimmed/capped.
- `technicalTrades`:
  - `total`: total number of picks.
  - `preview`: up to `REPORT_MAX_PICKS` items, each containing `{ symbol, trade: { side, entry, stop } }`.
  - `hasMore`: whether more than the preview exists.
- `watchlist`:
  - `total`: total number of watchlist names.
  - `preview`: up to `REPORT_MAX_WATCHLIST` items, each containing `{ symbol, trade: { side }, basis, move1dAtr14 }`.
  - `hasMore`: whether more than the preview exists.
- `mostActive`: `null` or `{ day, week }` where:
  - `day.top`: top-ranked (visible) 1d dollar volume rows.
  - `day.overflow`: the remainder as a ranked continuation.
  - `week.top`: top-ranked 5d dollar volume rows.
  - Each row is `{ key, symbol, bias, dollarVolumeLabel, moveLabel, atrLabel }`.
- `fullContext`: the long-form summary text used by the “Full context” expander.

All list entries include a precomputed `key` field; consumers must not derive alternate keys.

Example payload (shape only; values are illustrative):

```json
{
  "version": "v1-summary-widgets",
  "narrative": {
    "mainIdea": "Mixed tape: breadth improved while volatility stayed elevated.",
    "veryShort": "Mixed, watching breadth + vol for follow-through."
  },
  "sentiment": {
    "tone": "mixed",
    "lines": [
      { "key": "Breadth improving", "text": "Breadth improving" },
      { "key": "Volatility elevated", "text": "Volatility elevated" }
    ]
  },
  "technicalTrades": { "total": 0, "preview": [], "hasMore": false },
  "watchlist": {
    "total": 2,
    "preview": [
      {
        "key": "watch-0-AAPL",
        "symbol": "AAPL",
        "trade": { "side": "buy" },
        "basis": "trend",
        "move1dAtr14": 0.7
      }
    ],
    "hasMore": true
  },
  "mostActive": null,
  "fullContext": "Longer summary text used by the full-context expander."
}
```

Versioning policy:

- Breaking changes (rename/remove fields, change required/optional status, change meanings) must bump `version` and keep the renderer compatible with historical versions.
- Additive changes (adding optional fields) can stay on the same `version`, but should be documented here.
- Compatibility logic should live in the report renderer (`src/components/report/ReportSummary.tsx`), and we should keep support for all historical versions unless we also provide a migration that rewrites older MDX.

All invariants in this section apply to `version = "v1-summary-widgets"`. Future versions may refine these rules but must maintain compatibility for historical reports.

## Creates

- Artifact: PR
- Title pattern: "Daily market report: <YYYY-MM-DD>"
- Branch: `proactive/market-report-YYYYMMDD`

## Prerequisites

- Capabilities: GitHub + Devbox
- Tooling: Bun

## Limits

- Max artifacts per run: 1 PR
- Allowed paths:
  - `content/data/**` (only new snapshots for the run date)
  - `content/reports/**` (only the run date)
- Guardrails:
  - Previous (non-today) dates are treated as immutable. Don't modify existing `content/data/**/<YYYYMMDD>.json` snapshots or `content/reports/<DATE>.*` for past dates.
  - For today's date (America/New_York), reruns are allowed to pick up late news/videos and fill missing OHLCV timestamps.
  - Do not change `config/**` or any source code in this playbook.
  - Trade ideas / setups should be based on tradeable symbols. Market internals (breadth/volume) and regime indicators (e.g., `^VIX`) can be referenced for context, but shouldn't be the sole basis for a trade.

## No-op when

- `content/reports/<DATE>.mdx` already exists.

## Steps

1. Set `<DATE>` to today in `America/New_York` (YYYY-MM-DD).
2. Run:

   ```bash
   bun --version
   bun install
   # Runs acquire → analyze → aggregate → report → summarize for the given date
   bun run market:run --date=<DATE>
   ```

3. Confirm these files exist:
   - `content/reports/<DATE>.mdx`
   - `content/reports/<DATE>.json`
   - (Optional cache) `content/reports/<DATE>.highlights.json`

   Note: the generated MDX includes a precomputed `ReportSummary` payload so the UI can render the summary widgets without additional client-side aggregation.
4. Create a PR containing:

   - `content/data/**/<YYYYMMDD>.json` snapshots for the run date (OHLCV + news + CNBC)
   - `content/reports/<DATE>.mdx`
   - `content/reports/<DATE>.json`
   - (Optional) `content/reports/<DATE>.highlights.json`

## Verify

- Run `bun run build` to ensure the site still renders the new MDX.

## Rollback

- Close the PR.
